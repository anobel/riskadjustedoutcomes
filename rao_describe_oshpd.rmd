---
title: "Risk Adjusted Outcomes for Urologic Oncology"
subtitle: "OSHPD Data Descriptions"
author: "Anobel Y Odisho, Ruth Etzioni, John L Gore"
date: "`r Sys.Date()`"
output: 
  tufterhandout::html_tufte_handout:
        theme: cosmo
        css: floating.css
        toc: yes
params:
    cohort: "Cystectomy"
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, fig.width=12, cache=T)
```

<!--- this inline CSS style is to alter horizontal table padding for stargazer tables -->
<style>
  td {
    padding-left: 3px;
    padding-right: 3px;
  }
</style>
  

```{r packages, cache=F}
# Data Cleaning Packages
library(lubridate)
library(plyr)
library(dplyr)
library(stringr)
library(tidyr)

# Graphics Packages
library(DT)
library(ggplot2)
library(ggthemes)
library(knitr)
library(RColorBrewer)
library(stargazer)

# Specialty/Stats Packages
library(icd9)
library(ROCR)
library(lme4)
```

```{r constants.functions}
bg <- "#FCFCFA"
main1 <- "#ca0020"
acc1 <- "#f4a582"
main2 <- "#92c5de"
acc2 <- "#0571b0"

# this function takes arguments x=value, y=number of sig figs, prints mean +/- SD in html
prettyMeanSD <- function (x,y) {
  mean <- prettyNum(round(mean(x, na.rm=TRUE),y), big.mark = ",")
  sd <-  prettyNum(round(sd(x, na.rm=TRUE),y), big.mark = ",")
  paste(mean, " &plusmn; ",sd,sep="")
}

prettyMedianIQR <- function (x,y) {
  median <- prettyNum(round(median(x, na.rm=TRUE),y), big.mark = ",")
  tiles <- round(quantile(x, c(.25, .75), na.rm=TRUE),y)
  paste(median, " (",tiles[1], " - ", tiles[2], ")",sep="")
}
```

```{r loaddata}
# Load full dataset (12.5m obs)
# when loading the full data set, in chunk options set cache.lazy=F
# pt <- readRDS(file="rao_workingdata/pt.rds")

# Load lite dataset (sample of 100,000 obs)
ptgu <- readRDS("rao_workingdata/ptgu.rds")

# make a disease specific cohort based on the parameter selected
# params <- list(); params$cohort="Cystectomy"
ptgucohort <- ptgu %>% filter(cohort==params$cohort)

# split data into training and validation cohorts
# Set random seed to reproduce results
set.seed(7)

# create an index variable which will allow splitting of training/test data without overlap
ptgucohort$index <- seq(1:nrow(ptgucohort))

# Group by OSHPD_ID, then take a 75% sample for training set
train <- ptgucohort %>%
  group_by(oshpd_id) %>%
  sample_frac(size=0.75, replace=F)
# anything that didnt make it into training set is put into a test set
test <- ptgucohort[!(ptgucohort$index %in% train$index),]

# remove index variables
ptgucohort <- ptgucohort %>% select(-index)
train <- train %>% select(-index)
test <- test %>% select(-index)
```

# Overall Summary
- Total Records: `r nrow(pt)`
- Records in GU specific cohort `r nrow(ptgu)`
- `r kable(t(table(ptgu$cohort)))`

```{r datafields, cache=F, results='asis'}
names(ptgucohort)
```

## Admission Dates
Overall Cohort
```{r overallCohortAdmissionDates}
pt %>%
  ggplot(aes(x=admtdate)) + 
  geom_histogram(fill=main2, color="white") + 
  theme_few() +
  theme(plot.background = element_rect(fill=bg), 
        legend.background= element_rect(fill=bg), 
        legend.title=element_blank()) + 
  labs(title="Admission Date Distribution, Entire Cohort", 
       y="Number of Admissions", 
       x="Admission Date")
```

Overall GU Cohort
```{r overallGuCohortAdmissionDates}
kable(t(table(ptgu$cohort)))

ptgu %>%
  ggplot(aes(x=admtdate, weight=1)) + 
  # geom_histogram(aes(y=..density..), fill=main2, alpha=0.3, color="white") +
  geom_density(aes(y=..count.., color=cohort)) +
  scale_color_brewer(palette = "Dark2") + 
  theme_few() +
  theme(plot.background = element_rect(fill=bg), 
        legend.background= element_rect(fill=bg), 
        legend.title=element_blank()) + 
  labs(title="Admission Dates for GU Cohort", 
       y="Number of Admissions", 
       x="Admission Date")
```

## Readmissions
Overall 30 day Readmission Rate (%)
```{r overall30dReadmissionRate, results="asis"}
t1 <- round(100*prop.table(table(pt$isreadmit30adm)),2)
t2 <- round(100*prop.table(table(ptgu$isreadmit30adm, ptgu$cohort),2),2)
t <- as.data.frame(cbind(t1, t2))
colnames(t)[1] <- "All Patients"
stargazer(t, summary=F, type="html", digits = 2)
```

## Disposition
Overall Disposition Distribution (%)
```{r overallDispo, results="asis"}
t1 <- round(100*prop.table(table(pt$disp)), 2)
t2 <- round(100*prop.table(table(ptgu$disp, ptgu$cohort),2),2)

t <- as.data.frame(cbind(t1, t2))
colnames(t)[1] <- "All Patients"
stargazer(t, summary=F, type="html", digits = 2, digits.extra = 2)
```

## Race/Ethnicity
(%)
```{r overallRace, results="asis"}
t1 <- round(100*prop.table(table(pt$race_grp)), 2)
t2 <- round(100*prop.table(table(ptgu$race_grp, ptgu$cohort),2),2)

t <- as.data.frame(cbind(t1, t2))
colnames(t)[1] <- "All Patients"
stargazer(t, summary=F, type="html", digits = 2, digits.extra = 2)
```

## Payers
Payer Category (%)
```{r overallPayers, results="asis"}
t1 <- round(100*prop.table(table(pt$pay_cat)), 2)
t2 <- round(100*prop.table(table(ptgu$pay_cat, ptgu$cohort),2),2)

t <- as.data.frame(cbind(t1, t2))
colnames(t)[1] <- "All Patients"
stargazer(t, summary=F, type="html")
```
<br>

Payer Type (%)
```{r, results="asis"}
t1 <- round(100*prop.table(table(pt$pay_type)), 2)
t2 <- round(100*prop.table(table(ptgu$pay_type, ptgu$cohort),2),2)

t <- as.data.frame(cbind(t1, t2))
colnames(t)[1] <- "All Patients"
stargazer(t, summary=F, type="html")
```

# `r params$cohort` Summary
- Records in `r params$cohort` specific cohort: `r nrow(ptgucohort)`
- For modeling, data split 75/25 into training (n=`r nrow(train)`) and testing (n=`r nrow(test)`) cohorts

# Fixed Effects
## Baseline Model
- Outcome: 30 day readmission from date discharge date after index admission
- Predictors: age (10yrs), sex

```{r logmodel1}
m1 <- glm(isreadmit30dc ~ agyradmcentered + sex, data=train, family="binomial")

summary(m1)

kable(exp(cbind(OR = coef(m1), confint(m1))))
```

Predicted Probability of Readmission
```{r logmodel1preds}
# Generate dataframe of dummy values to calculate predicted probabilities
newm1 <- data.frame(
  agyradmcentered = rep(seq(from=1.8, to=10, length.out = 100),2), 
  sex=factor(c(rep("Male",100), rep("Female",100))))

p1 <- cbind(newm1,predict(m1, newdata = newm1, type="link", se=T))
p1 <- within(p1, {
    PredictedProb <- plogis(fit)
    LL <- plogis(fit - (1.96 * se.fit))
    UL <- plogis(fit + (1.96 * se.fit))
})

ggplot(p1, aes(x = agyradmcentered*10, y = PredictedProb)) + 
  geom_ribbon(aes(ymin = LL, ymax = UL, fill = sex), alpha = 0.1) + 
  geom_line(aes(colour = sex), size = 1) + 
  theme_few() +
  theme(plot.background = element_rect(fill=bg), 
        legend.background= element_rect(fill=bg), 
        legend.title=element_blank())
```

Model Performance
```{r logmodel1performance, results="asis"}
# predict test data result
pr1 <- predict(m1, newdata=test, type="response")

pred1 <- prediction(pr1, test$isreadmit30dc)

# Calculate AUC
auc1 <- performance(pred1, measure="auc")
auc1 <- round(auc1@y.values[[1]],4)

# Generate ROC Curve
roc1 <- performance(pred1, measure="tpr", x.measure="fpr")
plot(roc1, colorize=T)

cat("AUC:", auc1)
```

## Elix Sum
- Outcome: 30 day readmission from date discharge date after index admission
- Predictors: age (10yrs), sex, Elixhauser Sum

```{r logmodel2}
m2 <- glm(isreadmit30dc ~ agyradmcentered + sex + elixsum, data=train, family="binomial")

summary(m2)

kable(exp(cbind(OR = coef(m2), confint(m2))))
```

Model Performance
```{r logmodel2performance, results="asis"}
# predict test data result
pr2 <- predict(m2, newdata=test, type="response")

pred2 <- prediction(pr2, test$isreadmit30dc)

# Calculate AUC
auc2 <- performance(pred2, measure="auc")
# Print results of AUC
auc2 <- round(auc2@y.values[[1]],4)

# Generate ROC Curve
roc2 <- performance(pred2, measure="tpr", x.measure="fpr")
plot(roc2, colorize=T)
cat("AUC:",auc2)
```

## Elix Index
- Outcome: 30 day readmission from date discharge date after index admission
- Predictors: age (10yrs), sex, Elixhauser Index (30 Categorical Vars)

```{r logmodel3}
fmla <- as.formula(paste("isreadmit30dc ~ agyradmcentered + sex +", paste(elixComorbidNamesAbbrev, collapse="+")))

print(fmla)

m3 <- glm(fmla, data=train, family="binomial")

summary(m3)

kable(exp(cbind(OR = coef(m3), confint(m3))))
```

Model Performance
```{r logmodel3performance, results="asis"}
# predict test data result
pr3 <- predict(m3, newdata=test, type="response")

pred3 <- prediction(pr3, test$isreadmit30dc)

# Calculate AUC
auc3 <- performance(pred3, measure="auc")
# Print results of AUC
auc3 <- round(auc3@y.values[[1]],4)

# Generate ROC Curve
roc3 <- performance(pred3, measure="tpr", x.measure="fpr")
plot(roc3, colorize=T)
cat("AUC:",auc3)
```

## Elix, Hospital ID
- Outcome: 30 day readmission from date discharge date after index admission
- Predictors: age (10yrs), sex, Elixhauser Index (30 Categorical Vars), Hospital ID as fixed effect
- Turns out this doesnt work due to a large number of hospitals (170), leading to 170 dummy variables.

# Mixed Effects Models
## Baseline ME
- Outcome: 30 day readmission from date discharge date after index admission
- Predictors: age (10yrs), sex
- Random Effect: Hospital

```{r MEmodel1}
me1 <- glmer(isreadmit30dc ~ agyradmcentered + sex + (1|oshpd_id), data=train, family="binomial")

# print raw results of regression
summary(me1)

# Calculate confidence intervals and odds ratios
me1ci <- confint(me1, parm = "beta_")
kable(exp(cbind(OR=fixef(me1), me1ci)))
```

Model Performance
```{r MEmodel1performance, results="asis"}
# predict test data result
pr1 <- predict(me1, newdata=test, allow.new.levels=T)

pred1 <- prediction(pr1, test$isreadmit30dc)

# Calculate AUC
auc1 <- performance(pred1, measure="auc")
auc1 <- round(auc1@y.values[[1]],4)

# Generate ROC Curve
roc1 <- performance(pred1, measure="tpr", x.measure="fpr")
plot(roc1, colorize=T)

cat("AUC:", auc1)
```

## ME Elix Sum
- Outcome: 30 day readmission from date discharge date after index admission
- Predictors: age (10yrs), sex, Elixhauser Sum. Hospital as random effect.

```{r MEmodel2}
me2 <- glmer(isreadmit30dc ~ agyradmcentered + sex + elixsum + (1 | oshpd_id), data=train, family="binomial")

# print raw results of regression
summary(me2)

# Calculate confidence intervals and odds ratios
me2ci <- confint(me2, parm = "beta_")
kable(exp(cbind(OR=fixef(me2), me2ci)))
```

Model Performance
```{r MEmodel2performance, results="asis"}
# predict test data result
pr2 <- predict(me2, newdata=test, allow.new.levels=T)

pred2 <- prediction(pr2, test$isreadmit30dc)

# Calculate AUC
auc2 <- performance(pred2, measure="auc")
auc2 <- round(auc2@y.values[[1]],4)

# Generate ROC Curve
roc2 <- performance(pred2, measure="tpr", x.measure="fpr")
plot(roc2, colorize=T)

cat("AUC:", auc2)
```

## ME Elix Index
- Outcome: 30 day readmission from date discharge date after index admission
- Predictors: age (10yrs), sex, Elixhauser Index Categories. Hospital as random effect.

```{r MEmodel3}
fmla <- as.formula(paste("isreadmit30dc ~ agyradmcentered + sex +", paste(elixComorbidNamesAbbrev, collapse="+"), " + (1 | oshpd_id)"))

print(fmla)

me3 <- glmer(fmla, data=train, family="binomial")

# print raw results of regression
summary(me3)

# Calculate confidence intervals and odds ratios
# me3ci <- confint(me3, parm = "beta_")
kable(as.data.frame((OR=exp(fixef(me3)))))
cat("confidence intervals dont converge")
```

Model Performance
```{r MEmodel3performance, results="asis"}
# predict test data result
pr3 <- predict(me3, newdata=test, allow.new.levels=T)

pred3 <- prediction(pr3, test$isreadmit30dc)

# Calculate AUC
auc3 <- performance(pred3, measure="auc")
auc3 <- round(auc3@y.values[[1]],4)

# Generate ROC Curve
roc3 <- performance(pred3, measure="tpr", x.measure="fpr")
plot(roc3, colorize=T)
cat("AUC:", auc3)
```

# ME with SES
## ME Elix Sum, HoodZ
- Outcome: 30 day readmission from date discharge date after index admission
- Predictors: age (10yrs), sex, Elixhauser Sum
- SES: Neighborhood Z-Score (continuous)
- Random Effect: Hospital

```{r MEmodel4}
me4 <- glmer(isreadmit30dc ~ agyradmcentered + sex + elixsum + hoodzscore + (1 | oshpd_id), data=train, family="binomial")

# print raw results of regression
summary(me4)

# Calculate confidence intervals and odds ratios
me4ci <- confint(me4, parm = "beta_")
kable(exp(cbind(OR=fixef(me4), me4ci)))
```

Model Performance
```{r MEmodel4performance, results="asis"}
# predict test data result
pr4 <- predict(me4, newdata=test, allow.new.levels=T)

pred4 <- prediction(pr4, test$isreadmit30dc)

# Calculate AUC
auc4 <- performance(pred4, measure="auc")
auc4 <- round(auc4@y.values[[1]],4)

# Generate ROC Curve
roc4 <- performance(pred4, measure="tpr", x.measure="fpr")
plot(roc4, colorize=T)

cat("AUC:", auc4)
```

## ME Elix Sum, HoodZ Quint
- Outcome: 30 day readmission from date discharge date after index admission
- Predictors: age (10yrs), sex, Elixhauser Sum
- SES: Neighborhood Z-Score (quintile)
- Random Effect: Hospital

```{r MEmodel5}
me5 <- glmer(isreadmit30dc ~ agyradmcentered + sex + elixsum + hoodquint + (1 | oshpd_id), data=train, family="binomial")

# print raw results of regression
summary(me5)

# Calculate confidence intervals and odds ratios
# me5ci <- confint(me5, parm = "beta_")
kable(exp(cbind(OR=fixef(me5))))
```

Model Performance
```{r MEmodel5performance, results="asis"}
# predict test data result
pr5 <- predict(me5, newdata=test, allow.new.levels=T)

pred5 <- prediction(pr5, test$isreadmit30dc)

# Calculate AUC
auc5 <- performance(pred5, measure="auc")
auc5 <- round(auc5@y.values[[1]],4)

# Generate ROC Curve
roc5 <- performance(pred5, measure="tpr", x.measure="fpr")
plot(roc5, colorize=T)

cat("AUC:", auc5)
```

## ME Elix Index, HoodZ
- Outcome: 30 day readmission from date discharge date after index admission
- Predictors: age (10yrs), sex, Elixhauser Index Categories
- SES: Neighborhood Z-Score 
- Hospital as random effect

```{r MEmodel6}
fmla <- as.formula(paste("isreadmit30dc ~ agyradmcentered + sex + hoodzscore +", paste(elixComorbidNamesAbbrev, collapse="+"), " + (1 | oshpd_id)"))

print(fmla)

me6 <- glmer(fmla, data=train, family="binomial")

# print raw results of regression
summary(me6)

# Calculate confidence intervals and odds ratios
# me3ci <- confint(me3, parm = "beta_")
# kable(as.data.frame((OR=exp(fixef(me6)))))
cat("confidence intervals dont converge")
```

Model Performance
```{r MEmodel6performance, results="asis"}
# predict test data result
pr6 <- predict(me6, newdata=test, allow.new.levels=T)

pred6 <- prediction(pr6, test$isreadmit30dc)

# Calculate AUC
auc6 <- performance(pred6, measure="auc")
auc6 <- round(auc6@y.values[[1]],4)

# Generate ROC Curve
roc6 <- performance(pred6, measure="tpr", x.measure="fpr")
plot(roc6, colorize=T)
cat("AUC:", auc6)
```

## ME Elix Index, HoodZ
- Outcome: 30 day readmission from date discharge date after index admission
- Predictors: age (10yrs), sex, Elixhauser Index Categories
- SES: Neighborhood Z-Score Quintile
- Hospital as random effect

```{r MEmodel7}
fmla <- as.formula(paste("isreadmit30dc ~ agyradmcentered + sex + hoodquint +", paste(elixComorbidNamesAbbrev, collapse="+"), " + (1 | oshpd_id)"))

print(fmla)

me7 <- glmer(fmla, data=train, family="binomial")

# print raw results of regression
summary(me7)

# Calculate confidence intervals and odds ratios
# me3ci <- confint(me3, parm = "beta_")
# kable(as.data.frame((OR=exp(fixef(me6)))))
cat("confidence intervals dont converge")
```

Model Performance
```{r MEmodel7performance, results="asis"}
# predict test data result
pr7 <- predict(me7, newdata=test, allow.new.levels=T)

pred7 <- prediction(pr7, test$isreadmit30dc)

# Calculate AUC
auc7 <- performance(pred7, measure="auc")
auc7 <- round(auc7@y.values[[1]],4)

# Generate ROC Curve
roc7 <- performance(pred7, measure="tpr", x.measure="fpr")
plot(roc7, colorize=T)
cat("AUC:", auc7)
```

```{r}
# add models with hospital as random effect

```
