---
title: "Risk Adjusted Outcomes for Urologic Oncology"
subtitle: "O/E Evaluation"
author: "Anobel Y Odisho, Ruth Etzioni, John L Gore"
date: "`r Sys.Date()`"
output: 
  tufterhandout::html_tufte_handout:
        theme: cosmo
        css: floating.css
        toc: yes
params:
    cohort: ""
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, fig.width=12, cache=F)
```

<!--- this inline CSS style is to alter horizontal table padding for stargazer tables -->
<style>
  td {
    padding-left: 3px;
    padding-right: 3px;
  }
</style>
  
```{r packages, cache=F}
# Data Cleaning Packages
library(dplyr)      # Data Management
library(tidyr)      # Data Cleaning
library(stringr)    # String manipulation

# Graphics Packages
library(ggplot2)    # Graphics
library(ggthemes)   # Themes for ggplot
library(DT)         # HTML Widget for Data Tables
library(stargazer)  # HTML Tables for regression results
library(knitr)
library(RColorBrewer)# Color palettes from Cynthia Brewer

# Specialty/Stats Packages
library(ROCR)       # Performance measures, ROC curves, AUC
library(lme4)       # Mixed Effects Models
library(coin)       # Permutation Testing
```

```{r constants.functions, cache=F}
bg <- "#FCFCFA"
main1 <- "#ca0020"
acc1 <- "#f4a582"
main2 <- "#92c5de"
acc2 <- "#0571b0"

resPairsTable <- function(x) {
  matsize <- length(grep("p_", names(pred)))
  p <- lapply(1:length(x), function(y) format.pval(x[[y]]$p.value, eps = 0.001, digits=3))
  ptable <- diag(matsize)
  ptable[lower.tri(ptable, diag=F)] <- p
  t(ptable)
  ptable <- matrix(ptable, nrow=matsize, ncol=matsize, byrow=T)
  rownames(ptable) = grep("p_", names(pred), value=T)
  colnames(ptable) = grep("p_", names(pred), value=T)
  ptable[ptable==0] <- ""
  ptable[ptable==1] <- ""
  return(kable(ptable))
}

## Function to generate table of permutation testing p-values
resPermsTable <- function(x) {
  p <- lapply(x, pvalue)
  matsize <- length(p)/2
  p <- lapply(p, function(y) format.pval(y, eps = 0.001, digits=3))
  ptable <- diag(matsize)
  ptable[lower.tri(ptable, diag=F)] <- p
  t(ptable)
  ptable <- matrix(ptable, nrow=matsize, ncol=matsize, byrow=T)  
  rownames(ptable) = grep("^r_", names(pred), value=T)
  colnames(ptable) = grep("^r_", names(pred), value=T)
  ptable[ptable==0] <- ""
  ptable[ptable==1] <- ""
  return(kable(ptable))
}

# function to calculate all possible combinations of ranks
comboDiffs <- function(x) {
          df <- lapply(seq_along(combinations), function (y) {
                    pred <- pred[pred$cohort==x,colnames(pred) %in% unlist(combinations[y])]
                    result <- unlist(pred[,1])-unlist(pred[,2])
                    return(result)
                    }) 
          names(df) <- paste(matrix(unlist(combinations), ncol = 2, byrow = TRUE)[,1], matrix(unlist(combinations), ncol = 2, byrow = TRUE)[,2], sep = "_vs_")
          df <- as.data.frame(df)
          df$cohort <- x
          return(df)
}


```

```{r loaddata}
# Import data, keep only Cystectomy, Partial Nephrectomy, and Radical Nephrectomy cohorts
# exclude hospitals with only 1 observation
ptgu <- readRDS("rao_workingdata/ptgu.rds") %>%
  filter(cohort %in% c("Cystectomy", "PartialNx", "RadNx")) %>%
  group_by(cohort, oshpd_id) %>%
  filter(n()>1)

# List variables that will be scaled for models
toscale <- c("agyradmcentered", "agyradm",
             "elixsum", 
             "bedsMean", "adcMean", "dsh_pctMean", "mcr_pctMean", "cmiMean",
             "ethwhite", "ethblack", "ethlatin", "ethasian", "ethother",
             "medianincome", "capincome", "housevalue",
             "edunohs",	"eduhs", "educollege", "empexec",
             "gini", "iceinc", "iceedu", "iceeth", "hoodzscore", 
             "km", "hours", 
             "los", "cohortmortality", "residentnum")

# scale and center variables
ptgu[,toscale] <- data.frame(lapply(ptgu[,toscale], scale, center=T, scale=T))
rm(toscale)

# split data into training and validation cohorts
# Set random seed to reproduce results
set.seed(7)

# create an index variable which will allow splitting of training/test data without overlap
ptgu$index <- seq(1:nrow(ptgu))

# Group by OSHPD_ID and cohort, then take a 75% sample for training set
train <- ptgu %>%
  group_by(cohort, oshpd_id) %>%
  sample_frac(size=0.75, replace=F)

# anything that didnt make it into training set is put into a test set
test <- ptgu[!(ptgu$index %in% train$index),]

# remove index variables
ptgu <- ptgu %>% select(-index)
train <- train %>% select(-index)
test <- test %>% select(-index)
```

```{r observedrankings}
# Calculate observed hospital level readmission rates and rankings, per cohort
ranks <- test %>%
	group_by(cohort, oshpd_id) %>%
	summarise(
		cases = n(),
		p_obs = sum(isreadmit30dc)/n()
		) %>%
	# filter(cases>4) %>%
	mutate(
	  r_obs = rank(p_obs, ties.method="average"))

ranks <- test %>% 
	group_by(oshpd_id) %>%
	select(oshpd_id, safetydsh, safetynaph, safetydsh4, safetydsh10) %>%
	distinct() %>%
	right_join(ranks)

ranks %>%
  group_by("Cohort" = cohort) %>%
  summarise(
    "Number of Hospitals in Test Data" = n()
  ) %>% kable()

ranks %>%
  group_by("Cohort" = cohort, "Safety Net Status" = safetynaph) %>%
  summarise(
    "Number of Hospitals in Test Data" = n()
  ) %>% kable()
```

# Models
- Base Model: Age, Sex, Elixhauser Sum
- Base with SES: Age, Sex, Elixhauser Sum, Diez-Roux Score, Ethnicity
- more to come here

P-values represent two sided Wilcoxon Rank Sum tests comparing rankings of predicted probabilites at the hospital level in non-SES models to models incoporating SES.

```{r models}
# run models for each cohort
results <- train %>%
  group_by(cohort) %>%
  do(
    "p_base" = glmer(isreadmit30dc ~ agyradm + sex + elixsum + (1|oshpd_id), data=., family="binomial"),
    "p_base_ses" = glmer(isreadmit30dc ~ agyradm + sex + elixsum + hoodzscore + ethwhite + (1|oshpd_id), data=., family="binomial"),
    "p_payer" = glmer(isreadmit30dc ~ agyradm + sex + elixsum + pay_cat + (1|oshpd_id), data=., family="binomial"),
    "p_payer_ses" = glmer(isreadmit30dc ~ agyradm + sex + elixsum + pay_cat + hoodzscore + ethwhite + (1|oshpd_id), data=., family="binomial")
  )
```

``` {r predictedprobs}
numcohorts <- length(unique(ptgu$cohort))
nummodels <- ncol(results)-1

# Generate predicted probabilities for admission
index <- lapply(1:numcohorts, function(x) seq(numcohorts+x,(nummodels+1)*numcohorts, by=numcohorts))

results <- unlist(results)
results <- lapply(index, function(x) results[x])

pred_cystectomy <- as.data.frame(lapply(results[[1]], function(x) predict(x, newdata=test[test$cohort=="Cystectomy",], type="response", allow.new.levels=T)))

pred_partialnx <- as.data.frame(lapply(results[[2]], function(x) predict(x, newdata=test[test$cohort=="PartialNx",], type="response", allow.new.levels=T)))

pred_radnx <- as.data.frame(lapply(results[[3]], function(x) predict(x, newdata=test[test$cohort=="RadNx",], type="response", allow.new.levels=T)))

pred_cystectomy <- cbind(test[test$cohort=="Cystectomy",], pred_cystectomy)
pred_partialnx <- cbind(test[test$cohort=="PartialNx",], pred_partialnx)
pred_radnx <- cbind(test[test$cohort=="RadNx",], pred_radnx)

names(pred_cystectomy) <- gsub("(^p_.+)([0-9])+", "\\1", names(pred_cystectomy))
names(pred_partialnx) <- gsub("(^p_.+)([0-9])+", "\\1", names(pred_partialnx))
names(pred_radnx) <- gsub("(^p_.+)([0-9])+", "\\1", names(pred_radnx))

pred_all <- rbind(pred_cystectomy, pred_partialnx, pred_radnx)
rm(pred_cystectomy, pred_partialnx, pred_radnx)

# extract names of columns for predicted probabilities
vars <- grep("p_", names(pred_all), value=T)
# replace the "p_" with "r_" to start the name, use it in the mutate_each_() function
vars_r <- setNames(vars, str_replace(vars, "p_", "r_"))

# calculate assign cohort/hospital specific predicted probabilities, then rank by cohort
pred <- pred_all %>%
  group_by(cohort, oshpd_id) %>%
  summarise_each(funs(mean), starts_with("p_")) %>%
  group_by(cohort) %>%
  mutate_each_(funs(rank(., ties.method="average")), vars_r) %>%
  right_join(ranks)

res_probs <- pred %>%
  select(-matches("dsh"), -cases, -oshpd_id) %>%
  group_by(cohort, safetynaph) %>%
  summarise_each(funs(mean(., na.rm=T)))%>%
  mutate_each(funs(.*100), matches("p_|pct_")) %>%
  group_by(cohort, safetynaph) %>%
  mutate_each(funs(sprintf("%.2f", .)))%>% 
  t() %>% as.data.frame()

res_names <- paste(unlist(res_probs[1,]), unlist(res_probs[2,]))
res_names <- str_replace_all(res_names, "FALSE", "Not SHN")
res_names <- str_replace_all(res_names, "TRUE", "SHN")
colnames(res_probs) <- res_names
res_probs <- res_probs[3:nrow(res_probs),]
rm(res_names)

# arrange by row names (all model probabilities first, then rankings)
res_probs <- res_probs[order(row.names(res_probs)),]

# This assigns results of wilcoxon rank sum tests to the table, but it is manual
# onerous once the nubmer of comparisons increases
# have made grids below
# res_wilcox <- pred %>% 
#   filter(!is.na(p_obs)) %>%
#   group_by(cohort) %>%
#   do(
#     "Pred Prob - Base SES" = wilcox.test(.$p_base, .$p_base_ses, paired = T, conf.int = T)$p.value
#   ) %>% t() %>% as.data.frame()
# 
# res_wilcoxcols <- unlist(res_wilcox[1,])
# res_wilcoxrows <- rownames(res_wilcox)[-1]
# res_wilcox <- as.data.frame(matrix(unlist(res_wilcox), nrow=nrow(res_wilcox)), stringsAsFactors = F)
# res_wilcox <- res_wilcox[-1,]
# 
# res_wilcox <- as.data.frame(lapply(res_wilcox, as.numeric))
# 
# res_wilcox <- as.data.frame(lapply(res_wilcox, format.pval, eps=0.001, digits=3), stringsAsFactors=F)
# 
# colnames(res_wilcox) <- paste0(res_wilcoxcols, " p-value")
# res_wilcox$id <- res_wilcoxrows
# 
# res_probs$id <- row.names(res_probs)
# res <- left_join(res_probs, res_wilcox)
# res[is.na(res)] <- ""
# rownames(res) <- res$id
# res$id <- NULL
# 
# res <- res[(sort(colnames(res)))]
# rm(res_wilcoxrows, res_wilcoxcols, index)

kable(res_probs)
```

## All Pairwise Combinations
p-values from Two Sample Wilcoxon Signed Rank Test (Mann-Whitney), comparing ranks of predicted probabilities of readmission

```{r}
# Rearrange columns to make p_obs first
pred <- pred %>%
  select(p_obs, starts_with("p_"), r_obs, starts_with("r_"), everything())

combinations <- combn(grep("p_", names(pred), value=T),2, simplify = F)

res_pairs_cystectomy <- lapply(seq_along(combinations), function (x) {
                  pred <- pred[pred$cohort=="Cystectomy",colnames(pred) %in% unlist(combinations[x])]
                  result <- wilcox.test(unlist(pred[,1]), unlist(pred[,2]), paired=T)
                  return(result)
                  })

res_pairs_partialnx <- lapply(seq_along(combinations), function (x) {
                  pred <- pred[pred$cohort=="PartialNx",colnames(pred) %in% unlist(combinations[x])]
                  result <- wilcox.test(unlist(pred[,1]), unlist(pred[,2]), paired=T)
                  return(result)
                  })

res_pairs_radnx <- lapply(seq_along(combinations), function (x) {
                  pred <- pred[pred$cohort=="RadNx",colnames(pred) %in% unlist(combinations[x])]
                  result <- wilcox.test(unlist(pred[,1]), unlist(pred[,2]), paired=T)
                  return(result)
                  })

# Rename list for legibility    
names(res_pairs_cystectomy) <- paste(matrix(unlist(combinations), ncol = 2, byrow = TRUE)[,1], matrix(unlist(combinations), ncol = 2, byrow = TRUE)[,2], sep = " vs. ")

names(res_pairs_partialnx) <- paste(matrix(unlist(combinations), ncol = 2, byrow = TRUE)[,1], matrix(unlist(combinations), ncol = 2, byrow = TRUE)[,2], sep = " vs. ")

names(res_pairs_radnx) <- paste(matrix(unlist(combinations), ncol = 2, byrow = TRUE)[,1], matrix(unlist(combinations), ncol = 2, byrow = TRUE)[,2], sep = " vs. ")
```

# Ranking Differences
## Cystectomy
```{r}
resPairsTable(res_pairs_cystectomy)
```

## Partial Nephrectomy
```{r}
resPairsTable(res_pairs_partialnx)
```

## Radical Nephrectomy
```{r}
resPairsTable(res_pairs_radnx)
```

# O-E Diff Tests
Permutation Testing
```{r}
# generate all possible combinations of ranks
combinations <- combn(grep("^r_", names(pred), value=T),2, simplify = F)

perms <- lapply(unique(pred$cohort), comboDiffs)
perms <- rbind_all(perms)

perms <- cbind(perms, "safetynaph" = factor(ifelse(pred$safetynaph, "Yes", "No")))

res_perm_cystectomy <- lapply(grep("^r_", colnames(perms)), function (x) {
  independence_test(perms[perms$cohort=="Cystectomy",x] ~ safetynaph, data=perms[perms$cohort=="Cystectomy",], ytrafo=rank_trafo, distribution=exact())
})

res_perm_partialnx <- lapply(grep("^r_", colnames(perms)), function (x) {
  independence_test(perms[perms$cohort=="PartialNx",x] ~ safetynaph, data=perms[perms$cohort=="PartialNx",], ytrafo=rank_trafo, distribution=exact())
})

res_perm_radnx <- lapply(grep("^r_", colnames(perms)), function (x) {
  independence_test(perms[perms$cohort=="RadNx",x] ~ safetynaph, data=perms[perms$cohort=="RadNx",], ytrafo=rank_trafo, distribution=exact())
})

names(res_perm_cystectomy) <- paste(matrix(unlist(combinations), ncol = 2, byrow = TRUE)[,1], matrix(unlist(combinations), ncol = 2, byrow = TRUE)[,2], sep = "_vs_")

names(res_perm_partialnx) <- paste(matrix(unlist(combinations), ncol = 2, byrow = TRUE)[,1], matrix(unlist(combinations), ncol = 2, byrow = TRUE)[,2], sep = "_vs_")

names(res_perm_radnx) <- paste(matrix(unlist(combinations), ncol = 2, byrow = TRUE)[,1], matrix(unlist(combinations), ncol = 2, byrow = TRUE)[,2], sep = "_vs_")
```

# Permutation Testing
## Cystectomy
```{r}
resPermsTable(res_perm_cystectomy)
```

## Partial Nephrectomy
```{r}
resPermsTable(res_perm_partialnx)
```

## Radical Nephrectomy
```{r}
resPermsTable(res_perm_radnx)
```

```{r eval=F}



# t <- perm %>% filter(cohort=="Cystectomy")
# 
# independence_test(changerank_base_v_base_ses ~ dsh, data =t, ytrafo = rank_trafo, distribution = exact())
# 
# table(t$dsh)
# table(t$safetydsh)
# wilcoxsign_test(p_base~p_base_ses, data=t, distribution="exact")
# 
# wilcoxsign_test(p_obs~p_base_ses, data=t, distribution="exact")



```

```{r oe, eval=F}
oe <- pred %>%
  group_by(cohort, safetydsh) %>%
  mutate(
    changerank_base_v_obs = r_base - r_obs,
    changerank_base_ses_v_obs = r_base_ses - r_obs,
    changerank_base_v_base_ses = r_base - r_base_ses)

oe
    summarise_each(funs(mean), starts_with("change"))

# you want your predicted rank to be WORSE (bigger) than the observed rank
# doing well relative to what is expected
# so r_base - r_obs should be POSITIVE

t <- pred %>% filter(cohort=="Cystectomy")
wilcox.test(t$p_obs, t$p_base, paired=T)
wilcox.test(t$p_obs, t$p_base_ses, paired=T)
wilcox.test(t$p_base, t$p_base_ses, paired=T)


oe %>% filter(cohort=="Cystectomy") %>%
ggplot(aes(x=reorder(oshpd_id, -changerank_base_v_base_ses), y=changerank_base_v_base_ses, fill=safetydsh)) +
  geom_bar(stat="identity", width=0.7) +
  scale_fill_brewer(palette = "Paired") +
  theme_few() + 
  theme(axis.line.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  theme(plot.background = element_rect(fill=bg), legend.background= element_rect(fill=bg))
  

oe %>% filter(cohort=="Cystectomy") %>%
ggplot(aes(x=reorder(oshpd_id, changerank_base_v_obs), y=changerank_base_v_obs, fill=safetydsh)) +
  geom_bar(stat="identity", width=0.7, position = position_dodge(width=0.2)) +
  labs(title="Predicted 30 Day Readmission Rate for Cystectomy by Safety Net Status (base)", x=NULL, y="30 Day Readmission Rate (%)") +
  scale_fill_brewer(palette = "Paired", name="Safety Net Status", labels=c("No", "Yes")) +
  theme_few() + 
  theme(axis.line.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  theme(plot.background = element_rect(fill=bg), legend.background= element_rect(fill=bg))


hist(oe$changerank_base_v_obs[oe$cohort=="Cystectomy"], breaks=50)

t.test(changerank_base_v_obs ~ safetydsh, data=oe[oe$cohort=="Cystectomy",])
t.test(changerank_base_ses_v_obs ~ safetydsh, data=oe[oe$cohort=="Cystectomy",])
t.test(changerank_base_v_base_ses ~ safetydsh, data=oe[oe$cohort=="Cystectomy",])

hist(oe$changerank_base_v_obs[oe$cohort=="Cystectomy"], breaks=50)

t.test(changerank_base_v_obs ~ safetydsh, data=oe[oe$cohort=="PartialNx",])
t.test(changerank_base_ses_v_obs ~ safetydsh, data=oe[oe$cohort=="PartialNx",])
t.test(changerank_base_v_base_ses ~ safetydsh, data=oe[oe$cohort=="PartialNx",])


t.test(changerank_base_v_obs ~ safetydsh, data=oe[oe$cohort=="RadNx",])
t.test(changerank_base_ses_v_obs ~ safetydsh, data=oe[oe$cohort=="RadNx",])
t.test(changerank_base_v_base_ses ~ safetydsh, data=oe[oe$cohort=="RadNx",])

    group_by(cohort, safetynaph) %>%
  summarise(
    mean(changerank_base_v_obs),
    mean(changerank_base_ses_v_obs),
    mean(changerank_base_v_base_ses)
  ) %>% t() %>% as.data.frame()



    oe %>% 
  filter(cohort=="Cystectomy") %>% 
  ungroup() %>%
  select(oshpd_id, r_obs, r_base, r_base_ses, starts_with("changerank")) %>%
  arrange(desc(changerank_base_v_obs))


oe %>%
  group_by(cohort) %>%
  do(
    base_v_obs_est = t.test(changerank_base_v_obs ~ safetynaph, data=.)$estimate,
    base_v_obs_pval = t.test(changerank_base_v_obs ~ safetynaph, data=.)$p.value,
    base_ses_v_obs_est = t.test(changerank_base_ses_v_obs ~ safetynaph, data=.)$estimate,
    base_ses_v_obs_pval = t.test(changerank_base_ses_v_obs ~ safetynaph, data=.)$p.value,
    base_v_base_ses_est = t.test(changerank_base_v_base_ses ~ safetynaph, data=.)$estimate,
    base_v_base_ses_pval = unlist(t.test(changerank_base_v_base_ses ~ safetynaph, data=.)$p.value)
  ) %>% t() %>% as.data.frame()


# change in rank in base model compared to observed


# change in rank in base model with SES compared to observed
# t.test(changerank_base_ses_v_obs ~  safetynaph, data=ranks)
# wilcox.test(ranks$p_base_ses, ranks$p_base, paired = T)
# 
# # change in rank in base model with SES compared to observed
# t.test(changerank_base_v_base_ses ~  safetynaph, data=ranks)
# wilcox.test(ranks$p_base_ses, ranks$p_base, paired = T)


```

```{r rankingfigs, eval=F}
# 30d Readmissions for cystectomy by safety net status
pred %>% filter(cohort=="Cystectomy" & !is.na(safetydsh)) %>%
ggplot(aes(x=reorder(oshpd_id, -p_obs), y=100*p_obs+.5, fill=safetydsh)) +
  geom_bar(stat="identity", width=0.7, position = position_dodge(width=0.2)) +
  labs(title="Observed 30 Day Readmission Rate for Cystectomy by Safety Net Status", x=NULL, y="30 Day Readmission Rate (%)") +
  scale_fill_brewer(palette = "Paired", name="Safety Net Status", labels=c("No", "Yes")) +
  theme_few() + 
  theme(axis.line.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  theme(plot.background = element_rect(fill=bg), legend.background= element_rect(fill=bg))


pred %>% filter(cohort=="Cystectomy" & !is.na(safetydsh)) %>%
ggplot(aes(x=reorder(oshpd_id, -p_base), y=100*p_base+.5, fill=safetydsh)) +
  geom_bar(stat="identity", width=0.7, position = position_dodge(width=0.2)) +
  labs(title="Predicted 30 Day Readmission Rate for Cystectomy by Safety Net Status (base)", x=NULL, y="30 Day Readmission Rate (%)") +
  scale_fill_brewer(palette = "Paired", name="Safety Net Status", labels=c("No", "Yes")) +
  theme_few() + 
  theme(axis.line.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  theme(plot.background = element_rect(fill=bg), legend.background= element_rect(fill=bg))

pred %>% filter(cohort=="Cystectomy" & !is.na(safetydsh)) %>%
ggplot(aes(x=reorder(oshpd_id, -p_base_ses), y=100*p_base_ses+.5, fill=safetydsh)) +
  geom_bar(stat="identity", width=0.7, position = position_dodge(width=0.2)) +
  labs(title="Predicted 30 Day Readmission Rate for Cystectomy by Safety Net Status (base+SES)", x=NULL, y="30 Day Readmission Rate (%)") +
  scale_fill_brewer(palette = "Paired", name="Safety Net Status", labels=c("No", "Yes")) +
  theme_few() + 
  theme(axis.line.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  theme(plot.background = element_rect(fill=bg), legend.background= element_rect(fill=bg))

# 30d Readmissions for Partial Nephrectomy by safety net status
pred %>% filter(cohort=="PartialNx" & !is.na(safetydsh)) %>%
ggplot(aes(x=reorder(oshpd_id, -p_obs), y=100*p_obs+.5, fill=safetydsh)) +
  geom_bar(stat="identity", width=0.7, position = position_dodge(width=0.2)) +
  labs(title="30 Day Readmission Rate for Partial Nephrectomy by Safety Net Status", x=NULL, y="30 Day Readmission Rate (%)") +
  scale_fill_brewer(palette = "Paired", name="Safety Net Status", labels=c("No", "Yes")) +
  theme_few() + 
  theme(axis.line.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  theme(plot.background = element_rect(fill=bg), legend.background= element_rect(fill=bg))

# 30d Readmissions for Radical Nephrectomy by safety net status
pred %>% filter(cohort=="RadNx" & !is.na(safetydsh)) %>%
ggplot(aes(x=reorder(oshpd_id, -p_obs), y=100*p_obs+.5, fill=safetydsh)) +
  geom_bar(stat="identity", width=0.7, position = position_dodge(width=0.2)) +
  labs(title="30 Day Readmission Rate for Radical Nephrectomy by Safety Net Status", x=NULL, y="30 Day Readmission Rate (%)") +
  scale_fill_brewer(palette = "Paired", name="Safety Net Status", labels=c("No", "Yes")) +
  theme_few() + 
  theme(axis.line.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  theme(plot.background = element_rect(fill=bg), legend.background= element_rect(fill=bg))
```

```{r eval=F}
ranks %>%
  filter(cohort=="Cystectomy") %>%
  filter(safetynaph==T) %>%
  select(oshpd_id, r_obs, r_base, r_base_ses) %>%
  arrange(desc(r_base_ses)) %>%
  write.csv("temp.csv")

 

```











